<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uniform Configurator</title>

    <!-- Preconnect to external origins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Preload critical resources -->
    <link rel="preload" href="/fonts/Inter-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
    <link rel="preload" href="/assets/base-uniform-texture.jpg" as="image">

    <!-- Critical CSS (inlined) -->
    <style>
        /* Critical above-the-fold styles */
        body {
            margin: 0;
            padding: 0;
            background: #1a1a1a;
            color: #ffffff;
            font-family: Inter, system-ui, -apple-system, sans-serif;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        .viewer-panel {
            flex: 1;
            position: relative;
            background: #000;
        }

        #three-container {
            width: 100%;
            height: 100%;
        }

        /* Loading screen styles */
        .app-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            font-family: Inter, system-ui, sans-serif;
        }

        .loading-logo {
            width: 80px;
            height: 80px;
            margin-bottom: 2rem;
            border-radius: 16px;
            background: linear-gradient(45deg, #00ff88, #0066cc);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            color: white;
            animation: loading-pulse 2s ease-in-out infinite;
        }

        .loading-progress {
            width: 300px;
            height: 4px;
            background: #333;
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .loading-bar {
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #0066cc);
            border-radius: 2px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .loading-text {
            color: #cccccc;
            font-size: 14px;
            margin-bottom: 0.5rem;
        }

        .loading-details {
            color: #888888;
            font-size: 12px;
            font-family: monospace;
        }

        @keyframes loading-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Hide app content while loading */
        .app-loading ~ .app-container {
            display: none;
        }

        /* Critical error styles */
        .critical-error {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1a1a1a;
            color: #ffffff;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999999;
            font-family: Arial, sans-serif;
        }

        .error-content {
            background: #2a2a2a;
            padding: 2rem;
            border-radius: 12px;
            max-width: 500px;
            text-align: center;
        }

        .error-content h2 {
            color: #ff4444;
            margin: 0 0 1rem 0;
        }
    </style>

    <!-- Non-critical CSS (loaded asynchronously) -->
    <link rel="preload" href="styles-tokens.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'">

    <!-- Fallback for browsers that don't support preload -->
    <noscript>
        <link rel="stylesheet" href="styles-tokens.css">
        <link rel="stylesheet" href="styles.css">
    </noscript>

    <!-- Prefetch next likely resources -->
    <link rel="prefetch" href="/js/layers.js">
    <link rel="prefetch" href="/js/ui.js">
    <link rel="prefetch" href="/js/config.js">

    <!-- App metadata -->
    <meta name="description" content="3D Uniform Configurator with advanced texture editing and real-time preview">
    <meta name="theme-color" content="#1a1a1a">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">

    <!-- Performance monitoring -->
    <script>
        // Mark critical performance metrics
        if ('performance' in window) {
            performance.mark('page-start');
        }

        // Global error handler for loading issues
        window.addEventListener('error', function(e) {
            console.error('Loading error:', e.error);
            if (e.filename && e.filename.includes('.js')) {
                showLoadingError('Failed to load JavaScript module: ' + e.filename);
            }
        });

        // Unhandled promise rejection handler
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
            showLoadingError('Application initialization failed: ' + e.reason);
        });

        function showLoadingError(message) {
            const loading = document.querySelector('.app-loading');
            if (loading) {
                loading.innerHTML = `
                    <div class="error-content">
                        <h2>Loading Failed</h2>
                        <p>${message}</p>
                        <button onclick="location.reload()" style="
                            background: #0066cc;
                            color: white;
                            border: none;
                            padding: 0.8rem 1.5rem;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 14px;
                        ">Reload Application</button>
                    </div>
                `;
            }
        }
    </script>
</head>
<body>
    <!-- Progressive loading screen -->
    <div class="app-loading" id="app-loading">
        <div class="loading-logo">UC</div>
        <div class="loading-progress">
            <div class="loading-bar" id="loading-bar"></div>
        </div>
        <div class="loading-text" id="loading-text">Initializing application...</div>
        <div class="loading-details" id="loading-details">Loading core systems</div>
    </div>

    <!-- Main application -->
    <div class="app-container">
        <div class="viewer-panel">
            <div id="three-container"></div>

            <!-- Reset button (bottom left) -->
            <div class="reset-button-container">
                <button id="reset-view-btn" class="reset-view-btn" title="Reset view to default state">‚ü≤</button>
            </div>

            <!-- FOV slider overlay -->
            <div id="fov-slider-overlay" class="fov-slider-overlay" style="display: none;">
                <div class="fov-slider-container">
                    <label for="fov-slider">FOV:</label>
                    <input type="range" id="fov-slider" min="10" max="50" step="1" value="35">
                    <span id="fov-value">35¬∞</span>
                </div>
            </div>

            <!-- Scale slider overlay -->
            <div id="scale-slider-overlay" class="scale-slider-overlay" style="display: none;">
                <div class="scale-slider-container">
                    <label for="scale-slider">ÌÅ¨Í∏∞:</label>
                    <input type="range" id="scale-slider" min="0.1" max="3" step="0.1" value="1">
                    <span id="scale-value">1.0</span>
                </div>

                <div class="section-separator"></div>

                <div class="rotate-flip-container">
                    <div class="rotate-slider-container">
                        <label for="rotate-slider">ÌöåÏ†Ñ:</label>
                        <input type="range" id="rotate-slider" min="0" max="359" step="1" value="0">
                        <span id="rotate-value">0¬∞</span>
                    </div>
                    <div class="flip-controls-container">
                        <label class="flip-checkbox-label">
                            <input type="checkbox" id="flip-horizontal-checkbox">
                            <span class="checkbox-text">Ï¢åÏö∞Î∞òÏ†Ñ</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="control-panel">
            <!-- File Upload Area -->
            <div class="file-drop-area" id="file-drop-area">
                <div class="file-drop-content">
                    <div class="upload-icon">üìÅ</div>
                    <p>Drop images here<br>or <span class="browse-link">browse files</span></p>
                    <p class="file-info">Support PNG, JPG, SVG (max 5MB)</p>
                </div>
                <input type="file" id="file-upload" multiple accept="image/*,.json" style="display: none;">
            </div>

            <!-- Layer Management -->
            <div class="panel-section">
                <div class="section-header">
                    <h3>Layers</h3>
                    <div class="section-controls">
                        <button id="delete-all-layers-btn" class="delete-all-btn" title="Delete all layers">üóëÔ∏è All</button>
                    </div>
                </div>
                <div id="layer-list" class="layer-list"></div>
            </div>

            <!-- Layer Properties -->
            <div class="panel-section">
                <h3>Properties</h3>
                <div id="layer-properties" class="layer-properties">
                    <p class="no-selection">Select a layer to edit properties</p>
                </div>
            </div>

            <!-- Actions -->
            <div class="panel-section">
                <div class="section-header">
                    <h3>Actions</h3>
                </div>
                <div class="action-buttons">
                    <button id="save-config-btn" class="action-btn">üíæ Save Config</button>
                    <button id="save-session-btn" class="action-btn">üìÑ Save Session</button>
                    <button id="load-session-btn" class="action-btn">üìÇ Load Session</button>
                    <button id="order-form-btn" class="action-btn">üõí Order</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification container -->
    <div id="notification-container" class="notification-container"></div>

    <!-- Progressive loading script -->
    <script>
        // Progressive loading controller
        class ProgressiveLoader {
            constructor() {
                this.progress = 0;
                this.stages = [
                    { name: 'Loading core systems', weight: 20 },
                    { name: 'Initializing 3D engine', weight: 30 },
                    { name: 'Loading texture system', weight: 25 },
                    { name: 'Setting up interface', weight: 15 },
                    { name: 'Finalizing setup', weight: 10 }
                ];
                this.currentStage = 0;
                this.updateUI();
            }

            setProgress(percent, stage = null) {
                this.progress = Math.min(100, Math.max(0, percent));
                if (stage !== null) {
                    this.currentStage = stage;
                }
                this.updateUI();
            }

            nextStage() {
                if (this.currentStage < this.stages.length - 1) {
                    this.currentStage++;
                    this.updateUI();
                }
            }

            updateUI() {
                const loadingBar = document.getElementById('loading-bar');
                const loadingText = document.getElementById('loading-text');
                const loadingDetails = document.getElementById('loading-details');

                if (loadingBar) {
                    loadingBar.style.width = this.progress + '%';
                }

                if (loadingText && this.stages[this.currentStage]) {
                    loadingText.textContent = this.stages[this.currentStage].name;
                }

                if (loadingDetails) {
                    loadingDetails.textContent = `${Math.round(this.progress)}% complete`;
                }
            }

            complete() {
                this.setProgress(100);
                setTimeout(() => {
                    const loadingElement = document.getElementById('app-loading');
                    if (loadingElement) {
                        loadingElement.style.opacity = '0';
                        loadingElement.style.transition = 'opacity 0.5s ease';
                        setTimeout(() => {
                            loadingElement.style.display = 'none';
                            if ('performance' in window) {
                                performance.mark('app-ready');
                                performance.measure('app-load-time', 'page-start', 'app-ready');
                            }
                        }, 500);
                    }
                }, 200);
            }
        }

        // Create global loader instance
        window.progressiveLoader = new ProgressiveLoader();

        // Preload check for critical resources
        function checkCriticalResources() {
            const criticalResources = [
                '/assets/base-uniform-texture.jpg'
            ];

            let loadedCount = 0;
            const totalCount = criticalResources.length;

            criticalResources.forEach(src => {
                const img = new Image();
                img.onload = img.onerror = () => {
                    loadedCount++;
                    const progress = (loadedCount / totalCount) * 15; // 15% for preloading
                    window.progressiveLoader.setProgress(progress);

                    if (loadedCount === totalCount) {
                        // Start loading main application
                        loadMainApplication();
                    }
                };
                img.src = src;
            });

            if (criticalResources.length === 0) {
                loadMainApplication();
            }
        }

        // Load main application with optimized strategy
        function loadMainApplication() {
            window.progressiveLoader.setProgress(20, 1);

            // Load optimized main script
            const useOptimized = new URLSearchParams(window.location.search).get('optimized') !== 'false';
            const mainScript = useOptimized ? './main-optimized.js' : './main.js';

            const script = document.createElement('script');
            script.type = 'module';
            script.src = mainScript;

            script.onload = () => {
                console.log('‚úÖ Main application loaded');

                // Bundle analyzer integration
                if (window.bundleAnalyzer) {
                    setTimeout(() => {
                        window.bundleAnalyzer.logReport();
                    }, 2000);
                }
            };

            script.onerror = () => {
                console.error('‚ùå Failed to load main application');
                showLoadingError('Failed to load main application script');
            };

            document.head.appendChild(script);
        }

        // Start progressive loading when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', checkCriticalResources);
        } else {
            checkCriticalResources();
        }

        // Performance monitoring
        if ('PerformanceObserver' in window) {
            const observer = new PerformanceObserver((list) => {
                for (const entry of list.getEntries()) {
                    if (entry.entryType === 'measure' && entry.name === 'app-load-time') {
                        console.log(`üìä App load time: ${Math.round(entry.duration)}ms`);
                    }
                }
            });
            observer.observe({ entryTypes: ['measure'] });
        }

        // Expose loader for external control
        window.setLoadingProgress = (percent, stage) => {
            if (window.progressiveLoader) {
                window.progressiveLoader.setProgress(percent, stage);
            }
        };

        window.completeLoading = () => {
            if (window.progressiveLoader) {
                window.progressiveLoader.complete();
            }
        };
    </script>
</body>
</html>